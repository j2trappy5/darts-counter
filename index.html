<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Darts 501 Calculator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0f0f10; color:#f5f5f5; }
    .wrap { max-width: 520px; margin: 0 auto; padding: 12px; }
    .card { background:#18181b; border:1px solid #2a2a2f; border-radius:16px; padding:12px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1 { font-size:18px; margin: 0 0 10px; }
    .big { font-size:28px; font-weight:700; }
    .muted { color:#b6b6bd; font-size:12px; }
    .btn { border:1px solid #2a2a2f; background:#222228; color:#f5f5f5; padding:10px 12px; border-radius:14px; font-size:16px; }
    .btn:active { transform: scale(0.99); }
    .btn.primary { background:#2b2b33; border-color:#3a3a44; }
    .btn.sel { outline: 2px solid #7c3aed; }
    .grid { display:grid; gap:8px; }
    .grid.nums { grid-template-columns: repeat(5, 1fr); }
    .grid.small { grid-template-columns: repeat(3, 1fr); }
    .log { margin-top:10px; max-height:120px; overflow:auto; }
    .pill { padding:6px 10px; border-radius:999px; background:#222228; border:1px solid #2a2a2f; font-size:13px; }
    input { width: 100%; box-sizing: border-box; padding:10px 12px; border-radius:12px; border:1px solid #2a2a2f; background:#0f0f10; color:#f5f5f5; font-size:16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Darts 501 (Double-Out)</h1>

      <div class="row">
        <div>
          <div class="muted">Current player</div>
          <div id="who" class="big">—</div>
        </div>
        <div>
          <div class="muted">Remaining</div>
          <div id="remain" class="big">—</div>
        </div>
        <div>
          <div class="muted">Darts left</div>
          <div id="dartsLeft" class="big">—</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <input id="p1" placeholder="Player 1 name" value="Player 1">
        <input id="p2" placeholder="Player 2 name" value="Player 2">
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <button class="btn primary" id="startBtn">Start / Reset</button>
        <button class="btn" id="undoBtn">Undo</button>
        <button class="btn" id="bustBtn">Bust (reset turn)</button>
      </div>

      <div style="height:10px"></div>

      <div class="muted">Multiplier</div>
      <div class="grid small" style="margin-top:6px">
        <button class="btn sel" data-m="S" id="mS">Single (S)</button>
        <button class="btn" data-m="D" id="mD">Double (D)</button>
        <button class="btn" data-m="T" id="mT">Treble (T)</button>
      </div>

      <div style="height:10px"></div>

      <div class="muted">Numbers</div>
      <div class="grid nums" id="nums" style="margin-top:6px"></div>

      <div style="height:10px"></div>

      <div class="grid small">
        <button class="btn" id="missBtn">MISS (0)</button>
        <button class="btn" id="sbullBtn">25 (Single Bull)</button>
        <button class="btn" id="bullBtn">50 (Bull / Double)</button>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

<script>
  // --- Game state ---
  const START = 501;
  const THROWS_PER_TURN = 3;

  let players = [];
  let scores = {};
  let turn = 0;                 // index in players
  let dartsLeft = THROWS_PER_TURN;
  let startOfTurnScore = START; // for bust reset
  let history = [];             // for Undo: stack of snapshots
  let mult = "S";               // S / D / T

  const whoEl = document.getElementById("who");
  const remainEl = document.getElementById("remain");
  const dartsLeftEl = document.getElementById("dartsLeft");
  const logEl = document.getElementById("log");

  function snap() {
    // store enough to undo
    history.push({
      players: [...players],
      scores: {...scores},
      turn,
      dartsLeft,
      startOfTurnScore,
      mult,
      logHtml: logEl.innerHTML
    });
  }

  function restore(s) {
    players = [...s.players];
    scores = {...s.scores};
    turn = s.turn;
    dartsLeft = s.dartsLeft;
    startOfTurnScore = s.startOfTurnScore;
    mult = s.mult;
    logEl.innerHTML = s.logHtml;
    render();
    renderMultButtons();
  }

  function log(msg) {
    logEl.innerHTML = `<div class="pill">${msg}</div>` + logEl.innerHTML;
  }

  function currentPlayer() {
    return players[turn];
  }

  function render() {
    if (players.length === 0) {
      whoEl.textContent = "—";
      remainEl.textContent = "—";
      dartsLeftEl.textContent = "—";
      return;
    }
    const name = currentPlayer();
    whoEl.textContent = name;
    remainEl.textContent = scores[name];
    dartsLeftEl.textContent = dartsLeft;
  }

  function renderMultButtons() {
    document.getElementById("mS").classList.toggle("sel", mult === "S");
    document.getElementById("mD").classList.toggle("sel", mult === "D");
    document.getElementById("mT").classList.toggle("sel", mult === "T");
  }

  function startGame() {
    const p1 = document.getElementById("p1").value.trim() || "Player 1";
    const p2 = document.getElementById("p2").value.trim() || "Player 2";
    players = [p1, p2];
    scores = {[p1]: START, [p2]: START};
    turn = 0;
    dartsLeft = THROWS_PER_TURN;
    startOfTurnScore = START;
    history = [];
    logEl.innerHTML = "";
    mult = "S";
    renderMultButtons();
    log(`Game start: ${p1} vs ${p2} on ${START}`);
    render();
  }

  function nextTurn() {
    dartsLeft = THROWS_PER_TURN;
    turn = (turn + 1) % players.length;
    startOfTurnScore = scores[currentPlayer()];
    log(`Turn: ${currentPlayer()} (on ${scores[currentPlayer()]})`);
    render();
  }

  function applyThrow(points, isDoubleFinisher, label) {
    if (players.length === 0) return;

    snap(); // allow undo

    const name = currentPlayer();
    const before = scores[name];
    const after = before - points;

    // Real double-out bust rules:
    // bust if <0, ==1, or ==0 without double
    const bust = (after < 0) || (after === 1) || (after === 0 && !isDoubleFinisher);

    if (bust) {
      scores[name] = startOfTurnScore;
      log(`${name}: ${label} → BUST (reset to ${scores[name]})`);
      // bust ends the turn immediately
      nextTurn();
      return;
    }

    scores[name] = after;
    dartsLeft -= 1;
    log(`${name}: ${label} → ${before} → ${after}`);

    if (after === 0) {
      alert(`${name} wins! (finished on a double)`);
      startGame();
      return;
    }

    if (dartsLeft === 0) {
      nextTurn();
    } else {
      render();
    }
  }

  function bustTurn() {
    if (players.length === 0) return;
    snap();
    const name = currentPlayer();
    scores[name] = startOfTurnScore;
    log(`${name}: manual BUST (reset to ${scores[name]})`);
    nextTurn();
  }

  function undo() {
    const s = history.pop();
    if (!s) return;
    restore(s);
  }

  // --- Build number buttons 1..20 ---
  const numsEl = document.getElementById("nums");
  for (let n = 1; n <= 20; n++) {
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = n;
    b.addEventListener("click", () => {
      const m = (mult === "S") ? 1 : (mult === "D") ? 2 : 3;
      const points = n * m;
      const isDoubleFinisher = (mult === "D");
      applyThrow(points, isDoubleFinisher, `${mult}${n} (${points})`);
    });
    numsEl.appendChild(b);
  }

  // Multiplier selection
  document.querySelectorAll("[data-m]").forEach(btn => {
    btn.addEventListener("click", () => {
      mult = btn.getAttribute("data-m");
      renderMultButtons();
    });
  });

  // Specials
  document.getElementById("missBtn").addEventListener("click", () => applyThrow(0, false, "MISS (0)"));
  document.getElementById("sbullBtn").addEventListener("click", () => applyThrow(25, false, "SBULL 25"));
  document.getElementById("bullBtn").addEventListener("click", () => applyThrow(50, true, "BULL 50 (double)"));

  // Controls
  document.getElementById("startBtn").addEventListener("click", startGame);
  document.getElementById("undoBtn").addEventListener("click", undo);
  document.getElementById("bustBtn").addEventListener("click", bustTurn);

  // Start initial
  startGame();

  // PWA service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
</body>
</html>

